#!/bin/bash

# Xyvorra Linux - All-in-One Management Script
# Version 1.0.0
# Contains: Installation, User Setup, WiFi, and Menu System

# ============================================================================
# COLOR DEFINITIONS
# ============================================================================
PURPLE='\033[0;35m'
GREEN='\033[0;32m'
RED='\033[0;31m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m'

# ============================================================================
# BANNER FUNCTION
# ============================================================================
show_banner() {
    clear
    echo -e "${PURPLE}"
    cat << "EOF"

     Welcome to Xyvorra Linux v1.0.0
EOF
    echo -e "${NC}"
    echo ""
}

# ============================================================================
# MAIN MENU FUNCTION
# ============================================================================
show_menu() {
    show_banner
    echo -e "${BLUE}═══════════════════════════════════════════════════════${NC}"
    echo -e "${GREEN}  What would you like to do?${NC}"
    echo -e "${BLUE}═══════════════════════════════════════════════════════${NC}"
    echo ""
    echo -e "  ${GREEN}1)${NC} Install Xyvorra to Hard Drive"
    echo -e "  ${GREEN}2)${NC} Create User Account (Live Environment)"
    echo -e "  ${GREEN}3)${NC} Connect to WiFi"
    echo -e "  ${GREEN}4)${NC} Open Terminal"
    echo -e "  ${GREEN}5)${NC} Reboot"
    echo -e "  ${GREEN}6)${NC} Power Off"
    echo ""
    echo -e "  ${GREEN}0)${NC} Exit to Command Line"
    echo ""
    echo -e "${BLUE}═══════════════════════════════════════════════════════${NC}"
    echo ""
}

# ============================================================================
# INSTALLATION FUNCTION
# ============================================================================
install_system() {
    # Check root
    if [ "$EUID" -ne 0 ]; then 
        echo -e "${RED}This function requires root privileges${NC}"
        read -p "Press Enter to continue..."
        return
    fi

    # Banner
    show_banner
    echo -e "${BLUE}This installer will help you install Xyvorra Linux to your hard drive.${NC}"
    echo -e "${YELLOW}⚠ WARNING: This will format the selected disk and erase all data!${NC}"
    echo ""

    # Show available disks
    echo -e "${GREEN}Available disks:${NC}"
    echo ""
    lsblk -d -o NAME,SIZE,TYPE,MODEL | grep disk
    echo ""

    # Select disk
    while true; do
        read -p "Enter the disk name to install to (e.g., sda, nvme0n1): " DISK_NAME
        DISK="/dev/$DISK_NAME"
        
        if [ ! -b "$DISK" ]; then
            echo -e "${RED}Error: Disk $DISK not found!${NC}"
            continue
        fi
        
        # Show disk info
        echo ""
        echo -e "${YELLOW}Selected disk: $DISK${NC}"
        lsblk "$DISK"
        echo ""
        break
    done

    # Confirm destruction
    echo -e "${RED}═══════════════════════════════════════════════════════${NC}"
    echo -e "${RED}  WARNING: ALL DATA ON $DISK WILL BE DESTROYED!${NC}"
    echo -e "${RED}═══════════════════════════════════════════════════════${NC}"
    echo ""
    read -p "Type 'YES' in capital letters to continue: " CONFIRM

    if [ "$CONFIRM" != "YES" ]; then
        echo ""
        echo -e "${BLUE}Installation cancelled. No changes were made.${NC}"
        read -p "Press Enter to continue..."
        return
    fi

    # Ask for hostname
    echo ""
    read -p "Enter hostname for this computer (default: xyvorra): " HOSTNAME
    HOSTNAME=${HOSTNAME:-xyvorra}

    # Ask for timezone
    echo ""
    echo -e "${BLUE}Common timezones: America/New_York, America/Chicago, America/Los_Angeles${NC}"
    echo -e "${BLUE}                  Europe/London, Europe/Paris, Asia/Tokyo${NC}"
    read -p "Enter your timezone (default: America/Los_Angeles): " TIMEZONE
    TIMEZONE=${TIMEZONE:-America/Los_Angeles}

    # Start installation
    echo ""
    echo -e "${GREEN}╔═══════════════════════════════════════════════════╗${NC}"
    echo -e "${GREEN}║  Starting Xyvorra Linux Installation...          ║${NC}"
    echo -e "${GREEN}╚═══════════════════════════════════════════════════╝${NC}"
    echo ""

    # Unmount if already mounted
    umount -R /mnt 2>/dev/null

    # Step 1: Partition the disk
    echo -e "${BLUE}[1/9]${NC} Creating partitions..."
    parted -s "$DISK" mklabel gpt
    parted -s "$DISK" mkpart primary fat32 1MiB 513MiB
    parted -s "$DISK" set 1 esp on
    parted -s "$DISK" mkpart primary ext4 513MiB 100%

    # Detect partition naming scheme
    if [[ "$DISK" == *"nvme"* ]] || [[ "$DISK" == *"mmcblk"* ]]; then
        BOOT="${DISK}p1"
        ROOT="${DISK}p2"
    else
        BOOT="${DISK}1"
        ROOT="${DISK}2"
    fi

    # Wait for partitions to be recognized
    sleep 2

    # Step 2: Format partitions
    echo -e "${BLUE}[2/9]${NC} Formatting partitions..."
    mkfs.fat -F32 "$BOOT"
    mkfs.ext4 -F "$ROOT"

    # Step 3: Mount partitions
    echo -e "${BLUE}[3/9]${NC} Mounting partitions..."
    mount "$ROOT" /mnt
    mkdir -p /mnt/boot
    mount "$BOOT" /mnt/boot

    # Step 4: Copy system
    echo -e "${BLUE}[4/9]${NC} Copying system files (this will take several minutes)..."
    rsync -aAXH --info=progress2 \
        --exclude={"/dev/*","/proc/*","/sys/*","/tmp/*","/run/*","/mnt/*","/media/*","/lost+found","/swapfile"} \
        / /mnt/

    # Step 5: Create necessary directories
    echo -e "${BLUE}[5/9]${NC} Creating system directories..."
    mkdir -p /mnt/{dev,proc,sys,run,tmp,mnt,media}
    chmod 1777 /mnt/tmp

    # Step 6: Generate fstab
    echo -e "${BLUE}[6/9]${NC} Generating filesystem table..."
    genfstab -U /mnt >> /mnt/etc/fstab

    # Step 7: Configure system
    echo -e "${BLUE}[7/9]${NC} Configuring system..."

    # Set hostname
    echo "$HOSTNAME" > /mnt/etc/hostname

    # Configure hosts
    cat > /mnt/etc/hosts << EOF
127.0.0.1   localhost
::1         localhost
127.0.1.1   ${HOSTNAME}.localdomain ${HOSTNAME}
EOF

    # Set timezone
    arch-chroot /mnt ln -sf /usr/share/zoneinfo/$TIMEZONE /etc/localtime
    arch-chroot /mnt hwclock --systohc

    # Generate locale
    echo "en_US.UTF-8 UTF-8" >> /mnt/etc/locale.gen
    arch-chroot /mnt locale-gen
    echo "LANG=en_US.UTF-8" > /mnt/etc/locale.conf

    # Step 8: Install and configure bootloader
    echo -e "${BLUE}[8/9]${NC} Installing GRUB bootloader..."
    arch-chroot /mnt grub-install --target=x86_64-efi --efi-directory=/boot --bootloader-id=Xyvorra --recheck
    arch-chroot /mnt grub-mkconfig -o /boot/grub/grub.cfg

    # Step 9: Final configuration
    echo -e "${BLUE}[9/9]${NC} Finalizing installation..."

    # Remove live system auto-login
    rm -f /mnt/etc/systemd/system/getty@tty1.service.d/autologin.conf
    rm -f /mnt/etc/systemd/system/getty@tty1.service.d/override.conf
    
    # Remove xyvorra-start from root's bashrc on installed system
    sed -i '/xyvorra-start/d' /mnt/root/.bashrc

    # Enable important services
    arch-chroot /mnt systemctl enable NetworkManager
    arch-chroot /mnt systemctl enable sddm

    # Set up initramfs
    arch-chroot /mnt mkinitcpio -P

    # Create welcome message for installed system
    cat > /mnt/etc/motd << 'EOFMOTD'

╔═══════════════════════════════════════════════════════════╗
║                                                           ║
║  Welcome to Xyvorra Linux v1.0.0                         ║
║                                                           ║
║  To create your user account, run:                       ║
║      xyvorra-start                                       ║
║                                                           ║
║  For support: XyvorraApps@gmail.com                      ║
║                                                           ║
╚═══════════════════════════════════════════════════════════╝

EOFMOTD

    # Unmount
    echo ""
    echo -e "${BLUE}Unmounting filesystems...${NC}"
    umount -R /mnt

    # Success!
    echo ""
    echo -e "${GREEN}╔═══════════════════════════════════════════════════════╗${NC}"
    echo -e "${GREEN}║                                                       ║${NC}"
    echo -e "${GREEN}║  ✓ Xyvorra Linux installed successfully!             ║${NC}"
    echo -e "${GREEN}║                                                       ║${NC}"
    echo -e "${GREEN}╚═══════════════════════════════════════════════════════╝${NC}"
    echo ""
    echo -e "${BLUE}Installation Summary:${NC}"
    echo -e "  Disk:     ${GREEN}$DISK${NC}"
    echo -e "  Boot:     ${GREEN}$BOOT${NC}"
    echo -e "  Root:     ${GREEN}$ROOT${NC}"
    echo -e "  Hostname: ${GREEN}$HOSTNAME${NC}"
    echo -e "  Timezone: ${GREEN}$TIMEZONE${NC}"
    echo ""
    echo -e "${YELLOW}Next steps:${NC}"
    echo -e "  1. Remove the installation media"
    echo -e "  2. Reboot your computer"
    echo -e "  3. After booting, run: ${GREEN}xyvorra-start${NC}"
    echo -e "  4. Create your user account and set password"
    echo -e "  5. Reboot again and enjoy Xyvorra Linux!"
    echo ""
    echo -e "${PURPLE}Thank you for choosing Xyvorra Linux!${NC}"
    echo ""
    
    read -p "Press Enter to return to menu..."
}

# ============================================================================
# USER SETUP FUNCTION
# ============================================================================
create_user() {
    # Check root
    if [ "$EUID" -ne 0 ]; then 
        echo -e "${RED}This function requires root privileges${NC}"
        read -p "Press Enter to continue..."
        return
    fi

    show_banner
    echo -e "${BLUE}This wizard will help you create your user account.${NC}"
    echo ""

    # Get username
    while true; do
        read -p "Enter your desired username (lowercase, no spaces): " username
        
        # Validate username
        if [[ ! "$username" =~ ^[a-z][-a-z0-9]*$ ]]; then
            echo -e "${RED}Invalid username. Use lowercase letters, numbers, and hyphens only.${NC}"
            continue
        fi
        
        # Check if user already exists
        if id "$username" &>/dev/null; then
            echo -e "${RED}User '$username' already exists.${NC}"
            read -p "Do you want to modify this user? (y/n): " modify
            if [[ $modify == "y" ]]; then
                break
            else
                continue
            fi
        fi
        break
    done

    # Get full name
    read -p "Enter your full name (optional, press Enter to skip): " fullname

    # Get password
    while true; do
        read -s -p "Enter password for $username: " password
        echo ""
        read -s -p "Confirm password: " password2
        echo ""
        
        if [ "$password" != "$password2" ]; then
            echo -e "${RED}Passwords don't match. Please try again.${NC}"
            continue
        fi
        
        if [ ${#password} -lt 4 ]; then
            echo -e "${RED}Password must be at least 4 characters.${NC}"
            continue
        fi
        break
    done

    # Create user
    echo ""
    echo -e "${GREEN}Creating user account...${NC}"

    if id "$username" &>/dev/null; then
        echo "User already exists, updating password..."
        echo "$username:$password" | chpasswd
    else
        useradd -m -G wheel,audio,video,optical,storage,network -s /bin/bash "$username"
        echo "$username:$password" | chpasswd
        
        if [ -n "$fullname" ]; then
            chfn -f "$fullname" "$username"
        fi
    fi

    # Configure sudo access
    echo ""
    echo -e "${GREEN}Configuring sudo access...${NC}"
    sed -i 's/^# %wheel ALL=(ALL:ALL) ALL/%wheel ALL=(ALL:ALL) ALL/' /etc/sudoers

    # Set up user directories
    echo -e "${GREEN}Setting up user directories...${NC}"
    su - "$username" -c "xdg-user-dirs-update" 2>/dev/null

    # Configure SDDM to show the login screen
    echo -e "${GREEN}Configuring login screen...${NC}"
    mkdir -p /etc/sddm.conf.d
    cat > /etc/sddm.conf.d/autologin.conf << EOL
[Autologin]
# Autologin disabled - user must login
Session=plasma
EOL

    # Ask about default session
    echo ""
    read -p "Set KDE Plasma as default session? (Y/n): " kde_default
    if [[ ! $kde_default =~ ^[Nn]$ ]]; then
        echo "[Desktop]" > /home/$username/.dmrc
        echo "Session=plasma" >> /home/$username/.dmrc
        chown $username:$username /home/$username/.dmrc 2>/dev/null
    fi

    # Enable SDDM for next boot
    echo -e "${GREEN}Enabling login screen for next boot...${NC}"
    systemctl enable sddm.service 2>/dev/null

    # Success message
    echo ""
    echo -e "${PURPLE}═══════════════════════════════════════════════════${NC}"
    echo -e "${GREEN}✓ User account created successfully!${NC}"
    echo -e "${PURPLE}═══════════════════════════════════════════════════${NC}"
    echo ""
    echo -e "Username: ${BLUE}$username${NC}"
    if [ -n "$fullname" ]; then
        echo -e "Full Name: ${BLUE}$fullname${NC}"
    fi
    echo ""
    echo -e "${BLUE}You can now reboot and login with your new account.${NC}"
    echo -e "${BLUE}To reboot, select option 5 from the menu.${NC}"
    echo ""
    
    read -p "Press Enter to return to menu..."
}

# ============================================================================
# WIFI FUNCTION
# ============================================================================
connect_wifi() {
    clear
    echo -e "${BLUE}Opening Network Manager...${NC}"
    echo -e "${BLUE}Use arrow keys to navigate, Enter to select, Esc to go back${NC}"
    echo ""
    sleep 2
    nmtui
}

# ============================================================================
# TERMINAL FUNCTION
# ============================================================================
open_terminal() {
    clear
    echo -e "${GREEN}Exiting to terminal...${NC}"
    echo -e "${BLUE}Type 'xyvorra-start' to return to this menu${NC}"
    echo ""
    exit 0
}

# ============================================================================
# MAIN PROGRAM LOOP
# ============================================================================

# Check if running as root
if [ "$EUID" -ne 0 ]; then
    show_banner
    echo -e "${YELLOW}Note: Some functions require root privileges.${NC}"
    echo -e "${YELLOW}Run with sudo for full functionality: ${GREEN}sudo xyvorra-start${NC}"
    echo ""
    read -p "Press Enter to continue with limited access..."
fi

# Main menu loop
while true; do
    show_menu
    read -p "Select an option [0-6]: " choice
    
    case $choice in
        1)
            install_system
            ;;
        2)
            create_user
            ;;
        3)
            connect_wifi
            ;;
        4)
            open_terminal
            ;;
        5)
            echo ""
            echo -e "${YELLOW}Rebooting...${NC}"
            systemctl reboot
            ;;
        6)
            echo ""
            echo -e "${YELLOW}Powering off...${NC}"
            systemctl poweroff
            ;;
        0)
            open_terminal
            ;;
        *)
            echo ""
            echo -e "${RED}Invalid option. Please try again.${NC}"
            sleep 2
            ;;
    esac
done

#!/bin/bash
# Xyvorra User Setup Script
# Version 2.0.0

# Colors for terminal output
PURPLE='\033[0;35m'
GREEN='\033[0;32m'
RED='\033[0;31m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m' # No Color

# Functions for cleaner output
print_header() {
    echo -e "${PURPLE}${BOLD}$1${NC}"
}

print_success() {
    echo -e "${GREEN}✓${NC} $1"
}

print_error() {
    echo -e "${RED}✗${NC} $1"
}

print_info() {
    echo -e "${CYAN}ℹ${NC} $1"
}

print_prompt() {
    echo -e "${BLUE}→${NC} $1"
}

# Xyvorra banner
clear
echo -e "${PURPLE}"
cat << "EOF"
 __   __
 \ \ / /
  \ V /_   ___   _____  _ __ _ __ __ _
   > <| | | \ \ / / _ \| '__| '__/ _` |
  / . \ |_| |\ V / (_) | |  | | | (_| |
 /_/ \_\__, | \_/ \___/|_|  |_|  \__,_|
        __/ |
       |___/
EOF
echo -e "${BOLD}     Welcome to Xyvorra Linux v1.0.0${NC}"
echo -e "${PURPLE}            User Setup Wizard${NC}"
echo ""
echo -e "${PURPLE}═══════════════════════════════════════════════════${NC}"
echo ""

# Check if running as root
if [ "$EUID" -ne 0 ]; then
   print_error "This script must be run with sudo privileges"
   echo ""
   echo "Usage: sudo ./xyvorra-setup.sh"
   exit 1
fi

# Username input
print_header "Step 1: Username"
echo ""
while true; do
    read -p "$(echo -e ${BLUE}Username:${NC}) " username

    # Validate username
    if [[ -z "$username" ]]; then
        print_error "Username cannot be empty"
        continue
    fi

    if [[ ! "$username" =~ ^[a-z][-a-z0-9]*$ ]]; then
        print_error "Invalid format. Use lowercase letters, numbers, and hyphens only"
        continue
    fi

    if [ ${#username} -lt 3 ]; then
        print_error "Username must be at least 3 characters"
        continue
    fi

    # Check if user already exists
    if id "$username" &>/dev/null; then
        print_error "User '$username' already exists"
        read -p "$(echo -e ${YELLOW}Modify this user? \(y/n\):${NC}) " modify
        if [[ $modify =~ ^[Yy]$ ]]; then
            USER_EXISTS=true
            break
        else
            continue
        fi
    fi
    break
done

print_success "Username: $username"
echo ""

# Full name input
print_header "Step 2: Full Name"
echo ""
while true; do
    read -p "$(echo -e ${BLUE}Full Name:${NC}) " fullname

    if [[ -z "$fullname" ]]; then
        print_error "Full name cannot be empty"
        continue
    fi

    if [ ${#fullname} -lt 2 ]; then
        print_error "Please enter your full name"
        continue
    fi

    break
done

print_success "Full name: $fullname"
echo ""

# Password input
print_header "Step 3: Password"
echo ""
while true; do
    read -s -p "$(echo -e ${BLUE}Password:${NC}) " password
    echo ""
    read -s -p "$(echo -e ${BLUE}Confirm Password:${NC}) " password2
    echo ""

    if [ "$password" != "$password2" ]; then
        print_error "Passwords don't match. Please try again"
        echo ""
        continue
    fi

    break
done

print_success "Password set successfully"
echo ""

# Super user privileges
print_header "Step 4: User Privileges"
echo ""
print_info "Super users can install software and modify system settings"
while true; do
    read -p "$(echo -e ${BLUE}Grant super user privileges? \(y/n\):${NC}) " superuser

    if [[ $superuser =~ ^[Yy]$ ]]; then
        GROUPS="wheel,audio,video,optical,storage,network"
        print_success "User will have administrative privileges"
        break
    elif [[ $superuser =~ ^[Nn]$ ]]; then
        GROUPS="audio,video,optical,storage,network"
        print_success "User will have standard privileges"
        break
    else
        print_error "Please answer y or n"
    fi
done
echo ""

# Default shell selection
print_header "Step 5: Default Shell"
echo ""
print_info "Bash is recommended for most users"
while true; do
    read -p "$(echo -e ${BLUE}Shell \(bash/zsh\) [bash]:${NC}) " shell_choice

    # Default to bash if empty
    if [[ -z "$shell_choice" ]]; then
        shell_choice="bash"
    fi

    case $shell_choice in
        bash)
            USER_SHELL="/bin/bash"
            print_success "Shell: Bash"
            break
            ;;
        zsh)
            USER_SHELL="/bin/zsh"
            print_success "Shell: Zsh"
            break
            ;;
        *)
            print_error "Please choose bash or zsh"
            ;;
    esac
done
echo ""

# Creating user account
echo ""
print_header "Creating User Account"
echo ""
sleep 1

if [ "$USER_EXISTS" = true ]; then
    print_info "Updating existing user '$username'..."
    echo "$username:$password" | chpasswd
    chfn -f "$fullname" "$username"
    usermod -G "$GROUPS" "$username"
    usermod -s "$USER_SHELL" "$username"
else
    print_info "Creating new user '$username'..."
    useradd -m -G "$GROUPS" -s "$USER_SHELL" -c "$fullname" "$username"
    echo "$username:$password" | chpasswd
fi

if [ $? -eq 0 ]; then
    print_success "User account created successfully"
else
    print_error "Failed to create user account"
    exit 1
fi

# Configure sudo access if superuser
if [[ $superuser =~ ^[Yy]$ ]]; then
    print_info "Configuring sudo access..."
    sed -i 's/^# %wheel ALL=(ALL:ALL) ALL/%wheel ALL=(ALL:ALL) ALL/' /etc/sudoers
    print_success "Sudo access configured"
fi

# Set up user directories
print_info "Setting up user directories..."
su - "$username" -c "xdg-user-dirs-update" &>/dev/null
print_success "User directories created"

# Set KDE Plasma as default session
print_info "Configuring desktop environment..."
mkdir -p /home/$username
echo "[Desktop]" > /home/$username/.dmrc
echo "Session=plasma" >> /home/$username/.dmrc
chown -R $username:$username /home/$username/.dmrc
print_success "KDE Plasma configured as default session"

# Get hostname
while true; do
    read -p "Enter your desired hostname (lowercase, no spaces, hyphens allowed): " hostname_input
   
    # Validate hostname
    if [[ ! "$hostname_input" =~ ^[a-zA-Z0-9][-a-zA-Z0-9]*$ ]]; then
        echo -e "${RED}Invalid hostname. Use letters, numbers, and hyphens only.${NC}"
        continue
    fi
   
    break
done

# Set the hostname
echo -e "${GREEN}Setting hostname to '$hostname_input'...${NC}"
echo "$hostname_input" > /etc/hostname
hostnamectl set-hostname "$hostname_input"

# Update /etc/hosts
if ! grep -q "127.0.1.1" /etc/hosts; then
    echo "127.0.1.1    $hostname_input.localdomain $hostname_input" >> /etc/hosts
else
    sed -i "s/^127\.0\.1\.1.*/127.0.1.1    $hostname_input.localdomain $hostname_input/" /etc/hosts
fi

# Enable SDDM for next boot
echo -e "${GREEN}Enabling login screen for next boot...${NC}"
systemctl enable sddm.service


# Success summary
echo ""
echo -e "${PURPLE}═══════════════════════════════════════════════════${NC}"
echo -e "${GREEN}${BOLD}     ✓ User Setup Complete!${NC}"
echo -e "${PURPLE}═══════════════════════════════════════════════════${NC}"
echo ""
echo -e "${BOLD}Account Summary:${NC}"
echo -e "  ${CYAN}Username:${NC}     $username"
echo -e "  ${CYAN}Full Name:${NC}    $fullname"
echo -e "  ${CYAN}Shell:${NC}        $USER_SHELL"
if [[ $superuser =~ ^[Yy]$ ]]; then
    echo -e "  ${CYAN}Privileges:${NC}   ${GREEN}Super User (Administrator)${NC}"
else
    echo -e "  ${CYAN}Privileges:${NC}   Standard User"
fi
echo -e "  ${CYAN}Desktop:${NC}      KDE Plasma"
echo ""
echo -e "${BLUE}${BOLD}Next Steps:${NC}"
echo -e "  1. Type ${GREEN}reboot${NC} to restart your system"
echo -e "  2. Login with your new credentials at the SDDM screen"
echo -e "  3. Enjoy Xyvorra Linux!"
echo ""
echo -e "${PURPLE}═══════════════════════════════════════════════════${NC}"
echo ""
